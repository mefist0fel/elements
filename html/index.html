<html>
	<head>
		<title>Canvas loop</title>
		<style type="text/css">
		body {
			display: block;
			background-color:0;
			width: 100%;
			height: 100%;
			margin: 0;
		}
		canvas {
			background-color:#ffffff;
			display: block;
			margin: 10px auto;
		}
		</style>
	</head>
	<body>
		<canvas id="tutorial"></canvas>
	</body>
	<script type="text/javascript" src="geometry.js"></script>
	<script type="text/javascript" src="input.js"></script>
	<script type="text/javascript">
	var now,
		dt = 0,
		time = timestamp(),
		step = 1/30,
		ballCoord = [180, 150],
		ballVelocity = [1, 1],
		ballRadius = 20,
		width = 1024,
		height = 768;


	function GameObject() {
		var obj = {
			position: [0, 0],
			velocity: [0, 0],
			radius: 20
		}
		return obj;
	}

	// init
	var canvasElement = document.getElementById('tutorial');
	var canvas = canvasElement.getContext('2d');
	canvasElement.width = width;
	canvasElement.height = height;
	rect = canvasElement.getBoundingClientRect();

	var input = Input(rect, canvasElement);
	var player = GameObject();
	player.position = [100, 100];
	var bullet = [200];
	for(var i = 0; i < 200; i++) {
		bullet[i] = GameObject();
	}

	function timestamp() {
		return window.performance && window.performance.now ? window.performance.now() : new Date().getTime();
	}
	function render() {
		// colors of default paint
		canvas.strokeStyle    = '#000000';  // red
		// clear
		canvas.clearRect ( 0, 0, width, height);
		canvas.fillStyle= '#FF0000';  // red
		// circle - hero
		canvas.beginPath();
		canvas.arc(player.position[0], player.position[1], player.radius, 0, 2*Math.PI);
		canvas.closePath();
		canvas.fill();
		// quad
		canvas.strokeRect ( 400, 400, 100, 100);
		// circle
		canvas.beginPath();
		canvas.arc(200, 400, 50, 0, 2*Math.PI);
		canvas.closePath();
		canvas.stroke();
	}
	function update(dt) {
		// control
		player.velocity = [0, 0]
		// UP = 38
		// DOWN = 40
		// LEFT = 37
		// RIGHT = 39
		// W = 87
		// S = 83
		// A = 65
		// D = 68
		if (input.key[38] || input.key[87]) {
			player.velocity[1] -= 100;
		}
		if (input.key[40] || input.key[83]) {
			player.velocity[1] += 100;
		}
		if (input.key[37] || input.key[65]) {
			player.velocity[0] -= 100;
		}
		if (input.key[39] || input.key[68]) {
			player.velocity[0] += 100;
		}
		// angles
		newCoord = vAdd(player.position, vMult(player.velocity, dt));
		points = [[400, 400], [500, 400], [500, 500], [400, 500]];  // square angles
		for(var i = 0; i < 4; i++) {
			dist = magnitude(newCoord, points[i]);
			if (dist <= player.radius) {
				newCoord = vAdd(newCoord, vMult(vNorm(vSub(points[i], newCoord)), dist - player.radius));
			}
		}
		//sides
		if (vInRect(newCoord, [400 - player.radius, 400, 500 + player.radius, 500])) {
			if (newCoord[0] < 450) {
				newCoord[0] = 400 - player.radius;
			} else {
				newCoord[0] = 500 + player.radius;
			}
		}
		if (vInRect(newCoord, [400, 400 - player.radius, 500, 500 + player.radius])) {
			if (newCoord[1] < 450) {
				newCoord[1] = 400 - player.radius;
			} else {
				newCoord[1] = 500 + player.radius;
			}
		}
		// circle
		dist = magnitude(newCoord, [200, 400]);
		if (dist < player.radius + 50) {
			newCoord = vAdd(newCoord, vMult(vNorm(vSub([200, 400], newCoord)), dist - player.radius - 50));
		}
		player.position = newCoord;
	}
	function frame() {
		now = timestamp();
		dt = dt + Math.min(1, (now - time) / 1000);
		if (dt > step) {
			dt = step;
		}
		update(step);
		render();
		time = now;
		requestAnimationFrame(frame);
	}
	requestAnimationFrame(frame);
	</script>
</html>